name: Deploy UnderLand Bot

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Manual re-run option
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 350   # Just under 6h GitHub limit
    
    steps:
    - name: 🚀 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🐍 Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: 📦 Cache Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements_deployment.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: 🔧 Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_deployment.txt

    - name: 🔍 Environment Variables Check
      run: |
        echo "Checking environment variables..."
        if [ -z "${{ secrets.DISCORD_TOKEN }}" ]; then
          echo "❌ DISCORD_TOKEN secret is not set"
          exit 1
        else
          echo "✅ DISCORD_TOKEN is configured"
        fi

    - name: 🧪 Validate Bot Configuration
      run: |
        echo "Validating bot configuration..."
        python -c "
        import sys
        sys.path.append('.')
        try:
            from bot.config_deployment import DeploymentConfig
            config = DeploymentConfig()
            print('✅ Configuration validated successfully')
        except Exception as e:
            print(f'❌ Configuration error: {e}')
            sys.exit(1)
        "

    - name: 📝 Create .env file
      run: |
        cat <<EOF > .env
        DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
        WELCOME_CHANNEL_ID=${{ secrets.WELCOME_CHANNEL_ID }}
        OWNER_ID=${{ secrets.OWNER_ID }}
        ENVIRONMENT=production
        EOF
        
    - name: 🚀 Deploy UnderLand Bot
      run: python run_deployment.py

    - name: 🧹 Clean up environment file
      if: always()
      run: rm -f .env

